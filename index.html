<!--
/* The MIT License (MIT)
 *
 * Copyright (c) 2014 Oliver Bachmann, Karlsruhe, Germany
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
--> 
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>ANSI editor</title>
    <script src="scripts/ansi.js" type="text/javascript"></script>
    <script src="scripts/shape.js" type="text/javascript"></script>
	<script src="scripts/jquery-1.9.1.min.js" type="text/javascript"></script>
	<script src="scripts/jquery.simple-color.js" type="text/javascript"></script>
    
    <style type="text/css" media="screen">
    div.centered {
        margin: 0 auto;
    }
    </style>
    <script>
        var screenCharacterArray = Array();
                
        var ctx;
        var cursorShown=false;
        var ansimation;
        var cursorPosX=1;
        var cursorPosY=1;
        var cursorShown=true;
        var cursorInterval;
        var characterWidth, characterHeight;
        var insert=true;
        var currentBackground=0;
        var currentForeground=15;
        
        var ansiColors = [
      '000000', '800000', '008000', '808000', '000080', '800080', '008080', '808080', // ok
      'FF0000', '00FF00', 'FFFF00', '0000FF', 'FF00FF', '00FFFF', 'FFFFFF', '000000', // ok
      '000000', '00005F', '000087', '0000AF', '0000D7', '0000FF', '005F00', '005F5F', // ok
      'FF0000', 'FF0000', 'FF0000', 'cc33cc', 'cc99ff', 'cc66ff', 'cc33ff', '993399',
      'cc00cc', 'cc00ff', '9900cc', '990099', 'cc99cc', '996699', '663366', '660099',
      '9933cc', '660066', '9900ff', '9933ff', '9966cc', '330033', '663399', '6633cc',
      '6600cc', '9966ff', '330066', '6600ff', '6633ff', 'ccccff', '9999ff', '9999cc',
      '6666cc', '6666ff', '666699', '333366', '333399', '330099', '3300cc', '3300ff',
      '3333ff', '3333cc', '0066ff', '0033ff', '3366ff', '3366cc', '000066', '000033',
      '0000ff', '000099', '0033cc', '0000cc', '336699', '0066cc', '99ccff', '6699ff',
      '003366', '6699cc', '006699', '3399cc', '0099cc', '66ccff', '3399ff', '003399',
      '0099ff', '33ccff', '00ccff', '99ffff', '66ffff', '33ffff', '00ffff', '00cccc',
      '009999', '669999', '99cccc', 'ccffff', '33cccc', '66cccc', '339999', '336666',
      '006666', '003333', '00ffcc', '33ffcc', '33cc99', '00cc99', '66ffcc', '99ffcc',
      '00ff99', '339966', '006633', '336633', '669966', '66cc66', '99ff99', '66ff66',
      '339933', '99cc99', '66ff99', '33ff99', '33cc66', '00cc66', '66cc99', '009966',
      '009933', '33ff66', '00ff66', 'ccffcc', 'ccff99', '99ff66', '99ff33', '00ff33',
      '33ff33', '00cc33', '33cc33', '66ff33', '00ff00', '66cc33', '006600', '003300',
      '009900', '33ff00', '66ff00', '99ff00', '66cc00', '00cc00', '33cc00', '339900',
      '99cc66', '669933', '99cc33', '336600', '669900', '99cc00', 'ccff66', 'ccff33',
      'ccff00', '999900', 'cccc00', 'cccc33', '333300', '666600', '999933', 'cccc66',
      '666633', '999966', 'cccc99', 'ffffcc', 'ffff99', 'ffff66', 'ffff33', 'ffff00',
      'ffcc00', 'ffcc66', 'ffcc33', 'cc9933', '996600', 'cc9900', 'ff9900', 'cc6600',
      '993300', 'cc6633', '663300', 'ff9966', 'ff6633', 'ff9933', 'ff6600', 'cc3300',
      '996633', '330000', '663333', '996666', 'cc9999', '993333', 'cc6666', 'ffcccc',
      'ff3333', 'cc3333', 'ff6666', '660000', '990000', 'cc0000', 'ff0000', 'ff3300',
      'cc9966', 'ffcc99', 'ffffff', 'cccccc', '999999', '666666', '333333', '000000',
      '000000', '000000', '000000', '000000', '000000', '000000', '000000', '000000'
    ];
        
        function updateCanvasSize() {
            
        }
        function getImageWidth() {
            return 80; // return parseInt(document.getElementById('imagewidth').value);
        }
        function getImageHeight() {
            return 26; // return parseInt(document.getElementById('imageheight').value);
        }
        function getDisplayWidth() {
            return 80; // return parseInt(document.getElementById('displaywidth').value);
        }
        function getDisplayHeight() {
            return 26; // return parseInt(document.getElementById('displayheight').value);
        }
        
        function initansicanvas() {
                
                ansicanvas = document.getElementById('ansi');
                ansicanvas.addEventListener('mousedown', function(e) {
                    var mouse = getMousePos(ansicanvas, e);
                    var mx = mouse.x;
                    var my = mouse.y;                    
                    
                    showCharacter();
                    
                    cursorPosX = Math.floor(mx / characterWidth)+1;
                    cursorPosY = Math.floor(my / characterHeight)+1;
                    
                    redrawCursor();
                    
                }, true);
      
                cursorInterval = setInterval(function() { toggleCursor(); }, 500);
        }
        
        function setANSICanvasSize() {
            var displayWidth=getDisplayWidth();
            var displayHeight=getDisplayHeight();
            
            for (var y = 1; y <= displayHeight; y++) 
            {                    
                    var xArray = Array();
                    for (var x = 1; x <= displayWidth; x++) 
                    {
                     var data = Array();
                     data[0]=32; // ascii code
                     data[1]=15; // foreground color
                     data[2]=0; // background color
                     xArray[x]=data;
                    }
                    screenCharacterArray[y]=xArray;
                    console.log("y:"+y+" length:"+screenCharacterArray[y].length);
            }
           
        }
        
        function toggleCursor() {
            cursorShown=!cursorShown;
            ctx = document.getElementById("ansi").getContext("2d");
            
            if (cursorShown) {
                
            codepage.drawChar(ctx, insert==false ? 220 : 95, 15, 0, cursorPosX, cursorPosY, true); // shows cursor transparently
            
            } else {
                showCharacter();
            
            }
        }
        
        function redrawCursor() {
            cursorShown=true;
            clearInterval(cursorInterval);
            codepage.drawChar(ctx, insert==false ? 220 : 95, 15, 0, cursorPosX, cursorPosY, true); // shows cursor transparently
            cursorInterval = setInterval(function() { toggleCursor(); }, 500);
        }
        
        function showCharacter() {
            
            var asciiCode = screenCharacterArray[cursorPosY][cursorPosX][0];
            var foreground = screenCharacterArray[cursorPosY][cursorPosX][1];
            var background = screenCharacterArray[cursorPosY][cursorPosX][2];
            console.log("ascii:"+asciiCode+" fg:"+foreground+" bg:"+background);
            codepage.drawChar(ctx, asciiCode, foreground, background, cursorPosX, cursorPosY);
            
        }
        
       function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
    }
    
    function cursorMove() {
        
    }
    
   function handleKeyCode(keyCode,e) {
                console.log(keyCode);
                switch(keyCode){
                    case 45 : // Toggle insert/overwrite
                            insert=!insert;
                            break;
                    case 39 : // right
                              showCharacter();
                              if (cursorPosX<getDisplayWidth()) {
                                  cursorPosX++;
                                  redrawCursor();
                              }
                              return true;
                              break;
                          case 40 : // down
                              showCharacter();
                              if (cursorPosY<getDisplayHeight()) {
                              cursorPosY++;
                              redrawCursor();
                              }
                              return true;
                              break;
                          case 37: // left
                              showCharacter();
                              if (cursorPosX>1) {
                              cursorPosX--;
                              redrawCursor();
                            }
                            return true;
                              break;
                          case 38: // up
                              showCharacter();
                              if (cursorPosY>1) {
                              cursorPosY--;
                              redrawCursor();
                            }
                            return true;
                              break;
                          case 8:
                              cursorPosX--;
                              var currentPos = cursorPosX;
                              
                              while (currentPos < getDisplayWidth()) 
                              {
                                      var asciiCode = screenCharacterArray[cursorPosY][currentPos+1][0];
                                      var fgcolor = screenCharacterArray[cursorPosY][currentPos+1][1];
                                      var bgcolor = screenCharacterArray[cursorPosY][currentPos+1][2];
                                      codepage.drawChar(ctx, asciiCode, fgcolor, bgcolor, currentPos, cursorPosY);
                                      currentPos++;                                      
                              }
                              
                              redrawCursor();
                          return true;
                          case 46 :
                              var currentPos = cursorPosX;
                              while (currentPos < getDisplayWidth()) 
                              {
                                      var asciiCode = screenCharacterArray[cursorPosY][currentPos+1][0];
                                      var fgcolor = screenCharacterArray[cursorPosY][currentPos+1][1];
                                      var bgcolor = screenCharacterArray[cursorPosY][currentPos+1][2];
                                      codepage.drawChar(ctx, asciiCode, fgcolor, bgcolor, currentPos, cursorPosY);
                                      currentPos++;
                                      
                              }
                              return true;
                            break;
                          default : 
                              
                                  
                                  console.log("KEYCODE:"+keyCode);
                                if (insert==false) {
                                    codepage.drawChar(ctx, keyCode, currentForeground, currentBackground, cursorPosX, cursorPosY);
                                    if (cursorPosX<getDisplayWidth()) { cursorPosX++; }
                                    redrawCursor();
                                } else {
                                    var currentPos=getDisplayWidth();
                                    while (currentPos>cursorPosX) 
                                    {
                                      var asciiCode = screenCharacterArray[cursorPosY][currentPos-1][0];
                                      var fgcolor = screenCharacterArray[cursorPosY][currentPos-1][1];
                                      var bgcolor = screenCharacterArray[cursorPosY][currentPos-1][2];

                                      codepage.drawChar(ctx, asciiCode, fgcolor, bgcolor, currentPos, cursorPosY);
                                      currentPos--;
                                      
                                    }
                                    codepage.drawChar(ctx, keyCode, currentForeground, currentBackground, cursorPosX, cursorPosY);
                                    if (cursorPosX<getDisplayWidth()) { cursorPosX++; }
                                    redrawCursor();
                                }
                           
                              return true;
                              break;
                }
                return false;
   }
   function registerKeyEventListener() { 
		
                document.body.addEventListener('keypress',
                function(e)
                {
                    var keyCode = e.which;
                    
                    if ( (keyCode>=49) && (keyCode<=190) ) {
                    
                    if(window.handleKeyCode(keyCode,e)) e.preventDefault();
                    
                    }
                    else {
                        e.preventDefault();
                    }
                },
                false);
                
                document.body.addEventListener('keydown',
                function(e)
                {
                    var keyCode = e.keyCode;
                    
                    if ( ( (keyCode>=37) && (keyCode<49) ) || (keyCode>190) || (keyCode==8) || (keyCode==32) ) {
                        if(window.handleKeyCode(keyCode,e)) e.preventDefault();
                    } 
                },
                false);
                
    }
    
    $(document).ready(function(){
            $('.simple_color_kitchen_sink').simpleColor({
              boxHeight: 40,
              cellWidth: 20,
              cellHeight: 20,
              chooserCSS: { 'border': '1px solid #660033' },
              displayCSS: { 'border': '1px solid red' },
              displayColorCode: true,
              colors : ansiColors,
              livePreview: true,
              onSelect: function(hex, element) {
                alert("You selected #" + hex + " for input #" + element.attr('class'));
              },
              onCellEnter: function(hex, element) {
                console.log("You just entered #" + hex + " for input #" + element.attr('class'));
              },
              onClose: function(element) {
                alert("color chooser closed for input #" + element.attr('class'));
              }
            });
    });

        
    </script>
</head>
<body onload="registerKeyEventListener();initansicanvas();"> <!-- initboxcanvas(); -->
    <!--
    Image width: <input autocomplete="off" type="text" id="imagewidth" value="800">
    Image height: <input autocomplete="off" type="text" id="imageheight" value="500">
    Display width: <input autocomplete="off" type="text" id="displaywidth" value="80">
    Display height: <input autocomplete="off" type="text" id="displayheight" value="50">
    <br />
	<canvas id="boxcanvas" width="800" height="500" style="border: 1px solid black;">
        Your browser does not support canvas
        </canvas>
    --><div style="width: 640px" class="centered">
        <canvas id="ansi" width=640 height=480></canvas>
        <script type="text/javascript">
            setANSICanvasSize();
            
            codepage = new Codepage("images/CP_437_8x16.png", function() {
            
            var interpreter, display, ctx, charactersatonce;

            function drawChunk() {
                if (interpreter.read(charactersatonce, display)) {
             
                ctx.drawImage(display.canvas, 0, 0);
                } else {
                 
                    interpreter.reset();
                    display.clearScreen();
                    setTimeout(drawChunk, 5000);
                }
            }
            
            var width=80;
            var height=26;

            ctx = document.getElementById("ansi").getContext("2d");
            display = new Display(width || 80, height || 26);
            charactersatonce = 999999; //Math.floor((baud || 115200) / 8 / 100);
            
            interpreter = new Interpreter("rad-PIRANHA.ANS", drawChunk);
            
        });
        </script>
    </div>
 <input class='simple_color' value='#cc3333'/>
  <h3>Kitchen Sink</h3>
  <input class='simple_color_kitchen_sink' value='#993300'/>
</body>
</html>