<!--
/* The MIT License (MIT)
 *
 * Copyright (c) 2014 Oliver Bachmann, Karlsruhe, Germany
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
--> 
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>ANSI editor</title>
    <script src="scripts/ansi.js" type="text/javascript"></script>
    <script src="scripts/shape.js" type="text/javascript"></script>
    <script src="scripts/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="scripts/jquery.simple-color.js" type="text/javascript"></script>
    <script src="scripts/jquery.bpopup.js"></script>
    <link href="css/style.css" rel="stylesheet">
    <style type="text/css" media="screen">
        
    li {
    list-style-type: none;
    width: 50%;
    }

    li.left {
        float: left;
        
    }

    li.right {
        float: right;
        
    }

    @media only screen and (max-width: 480px) {
        .left, .right {
            float: none;
            width: 100%;
        }
    }
    </style>
    <script>
        var drawingMode = false;
        var mouseDown =false;
        var width=160;
        var height=52;
        var screenCharacterArray = Array();
                
        var currentCharset=1;
        var currentChar=216;
        
        var codepageImg;
        var currentColor=15;
        var ctx;
        var cursorShown=false;
        var ansimation;
        var cursorPosX=1;
        var cursorPosY=1;
        var cursorShown=true;
        var cursorInterval;
        var characterWidth, characterHeight;
        var insert=true;
        var currentBackground=0;
        var currentForeground=15;
        
        
        function setD(asciiCode, drawingBox) {
        
            currentCharset=drawingBox;
            currentChar=asciiCode;
        }
        
        var ansicolors = [
      '000000', 'cd0000', '00cd00', 'cdcd00', '1e90ff', 'cd00cd', '00cdcd', 'e5e5e5', '4c4c4c', 'ff0000',
      '00ff00', 'ffff00', '4682b4', 'ff00ff', '00ffff', 'FFFFFF', '000000', '00005F', '000087', '0000af', 
      '0000D7', '0000FF', '005F00', '005F5F', '005f87', '005faf', '005fd7', '005fff', '008700', '00875f', 
      '008787', '0087af', '0087d7', '0087ff', '00af00', '00af5f', '00af87', '00afaf', '00afd7', '00afff', 
      '00d700', '00d787', '00d787', '00d7af', '00d7af', '00d7ff', '00ff00', '00ff5f', '00ff87', '00ffaf', 
      '00ffd7', '00ffff', '5f0000', '5f5fff', '5f0087', '5f00af', '5f00d7', '5f00ff', '5f5f00', '5f5f5f', 
      '5f5f87', '5f5faf', '5f5fd7', '5f5fff', '5f8700', '5f875f', '5f8787', '5f87af', '5f87d7', '5f87ff', 
      '5faf00', '5faf5f', '5faf87', '5fafaf', '5fafd7', '5fafff', '5fd700', '5fd75f', '5fd787', '5fd7af', 
      '5fd7d7', '5fd7ff', '5fff00', '3399cc', '5fff87', '5fffaf', '5fffd7', '5fffff', '870000', '87005f', 
      '870087', '8700af', '8700af', '8700ff', '875f00', '875f5f', '875f87', '875faf', '875fd7', '875fff', 
      '878700', '87875f', '878787', '8787af', '8787d7', '8787ff', '87af00', '87af5f', '87af87', '87afaf', 
      '87afd7', '87afff', '87d700', '87d75f', '87d787', '87d7af', '87d7d7', '87d7ff', '87ff00', '87ff5f', 
      '87ff87', '87ffaf', '87ffd7', '87ffff', 'af0000', 'af005f', 'af0087', 'af00af', 'af00d7', 'af00ff', 
      'af5f00', 'af5f5f', 'af5f87', 'af5faf', 'af5fd7', 'af5fff', 'af8700', 'af875f', 'af8787', 'af87af', 
      'af87d7', 'af87ff', 'afaf00', 'afd7af', 'afaf87', 'afafaf', 'afafd7', 'afafff', 'afd700', 'afd75f', 
      'afd787', 'afd7af', 'afd7d7', 'afd7ff', 'afff00', 'afff5f', 'afff87', 'afffaf', 'afffd7', 'afffff', 
      'd70000', 'd7005f', 'dd2699', 'd700af', 'd700d7', 'd700ff', 'd75f00', 'd75f5f', 'd75f87', 'd75faf', 
      'd75fd7', 'd75fff', 'd78700', 'd7875f', 'd78787', 'd787af', 'd787d7', 'd787ff', 'd7af00', 'd7af5f', 
      'd7af87', 'd7afaf', 'd7afd7', 'd7afff', 'd7d75f', 'd7d75f', 'd7d787', 'd7d7af', 'd7d7d7', 'd7d7ff', 
      'd7ff00', 'd7ff5f', 'd7ff87', 'd7ffaf', 'd7ffd7', 'd7ffff', 'ff0000', 'ff005f', 'ff0087', 'ff00af', 
      'ff00d7', 'ff00ff', 'ff5f00', 'ff5f5f', 'ff5f87', 'ff5faf', 'ff5fd7', 'ff5fff', 'ff8700', 'ff875f', 
      'ff8787', 'ff87af', 'ff87d7', 'ffaf00', 'ffaf00', 'ffaf5f', 'ffaf87', 'ffafaf', 'ffafd7', 'ffafff', 
      'ffd700', 'ffd75f', 'ffd787', 'ffd7af', 'ffd7d7', 'ffd7ff', 'ffff00', 'ffff5f', 'ffff87', 'ffffaf',
      'ffffd7', 'ffffff', '080808', '121212', '1c1c1c', '262626', '303030', '3a3a3a', '444444', '4e4e4e',
      '585858', '626262', '6c6c6c', '767676', '808080', '8a8a8a', '949494', '9e9e9e', 'a8a8a8', 'b2b2b2',
      'bcbcbc', 'c6c6c6', 'd0d0d0', 'e4e4e4', 'e4e4e4', 'eeeeee', 'ffffff', '000000', '000000', '000000'
    ];
        
        function updateCanvasSize() {
            
        }
       
        function getDisplayWidth() {
            return width; // return parseInt(document.getElementById('displaywidth').value);
        }
        function getDisplayHeight() {
            return height; // return parseInt(document.getElementById('displayheight').value);
        }
        
        function initansicanvas() {
                setTimeout(function() { toggleCursor(true); }, 1000);
             
                ansicanvas = document.getElementById('ansi');
                ansicanvas.addEventListener('mousedown', function(e) {
                    mouseDown=true;
                    var mouse = getMousePos(ansicanvas, e);
                    var mx = mouse.x;
                    var my = mouse.y;                    
                    
                    showCharacter();
                    
                    cursorPosX = Math.floor(mx / canvasCharacterWidth)+1;
                    cursorPosY = Math.floor(my / canvasCharacterHeight)+1;
                    redrawCursor();
                   
                    console.log("drawing mode:"+drawingMode);
                    if (drawingMode) {
                        console.log("char:"+currentChar);
                        codepage.drawChar(ctx, currentChar, currentForeground, currentBackground, cursorPosX, cursorPosY, false); // false == update coordinate system
                    }
                    
                     
                    
                }, true);
                
                ansicanvas.addEventListener('mouseleave', function(e) {
                    mouseDown=false;
                });
                
                ansicanvas.addEventListener('mouseup', function(e) {
                   mouseDown=false; 
                });
                
                ansicanvas.addEventListener('mousemove', function(e) {
                   
                   if (mouseDown==true) {
                    
                    var mouse = getMousePos(ansicanvas, e);
                    var mx = mouse.x;
                    var my = mouse.y;                    
                    
                    showCharacter();
                    cursorPosX = Math.floor(mx / canvasCharacterWidth)+1;
                    cursorPosY = Math.floor(my / canvasCharacterHeight)+1;
                    redrawCursor();
                   if (drawingMode==true) {
                        codepage.drawChar(ctx, currentChar, currentForeground, currentBackground, cursorPosX, cursorPosY, false); // false == update coordinate system
                    }
                    
                   }
                   
                });

               
        }
        
        function setANSICanvasSize() {
            var displayWidth=getDisplayWidth();
            var displayHeight=getDisplayHeight();
            
            for (var y = 1; y <= displayHeight; y++) 
            {                    
                    var xArray = Array();
                    for (var x = 1; x <= displayWidth; x++) 
                    {
                     var data = Array();
                     data[0]=32; // ascii code
                     data[1]=15; // foreground color
                     data[2]=0; // background color
                     xArray[x]=data;
                    }
                    screenCharacterArray[y]=xArray;
                    
                    //console.log("y:"+y+" length:"+screenCharacterArray[y].length);
            }
           $('body').attr('onresize', 'resize_canvas();');
            
        }
        
        function toggleCursor(interval) {
     
            cursorShown=!cursorShown;
            ctx = document.getElementById("ansi").getContext("2d");
            
            if (cursorShown) {
            // Depending on what cursor is active, shows character code 220 or character code 95
            codepage.drawChar(ctx, insert==false ? 220 : 95, 15, 0, cursorPosX, cursorPosY, true); // shows cursor transparently
            
            } else {
                showCharacter();
            }
            
            if ( (typeof(interval)!="undefined") && (interval==true) ) {
                setTimeout(function() { toggleCursor(true); }, 500);
            }
            
        }
        
        function redrawCursor() {
            cursorShown=true;
            //clearInterval(cursorInterval);
            ctx = document.getElementById("ansi").getContext("2d");
        
            codepage.drawChar(ctx, insert==false ? 220 : 95, 15, 0, cursorPosX, cursorPosY, true); // shows cursor transparently
            //cursorInterval = setInterval(function() { toggleCursor(); }, 500);
        }
        
        function showCharacter() {
            
            var asciiCode = screenCharacterArray[cursorPosY][cursorPosX][0];
            var foreground = screenCharacterArray[cursorPosY][cursorPosX][1];
            var background = screenCharacterArray[cursorPosY][cursorPosX][2];
            console.log("ascii:"+asciiCode+" fg:"+foreground+" bg:"+background);
            ctx = document.getElementById("ansi").getContext("2d");
     
            codepage.drawChar(ctx, asciiCode, foreground, background, cursorPosX, cursorPosY, false);
            
        }
        
       function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
    }
    
    function cursorMove() {
        
    }
    
   function handleKeyCode(keyCode,e) {
                console.log(keyCode);
                
                var keys = new Array();
                keys[0] = [ 49, 50, 51, 52, 53, 54, 55, 56, 57, 48 ];
                keys[1] = [ 218, 191, 192, 217, 196, 179, 195, 180, 193, 194 ];
                keys[2] = [ 201, 187, 200, 188, 205, 186, 204, 185, 202, 203 ];
                keys[3] = [ 251, 184, 212, 190, 205, 179, 198, 181, 207, 209 ];
                keys[4] = [ 161, 183, 211, 135, 179, 186, 199, 182, 208, 144 ];
                keys[5] = [ 197, 206, 139, 140, 232, 163, 155, 156, 153, 239 ];
                keys[6] = [ 176, 177, 178, 219, 223, 219, 124, 141, 254, 250 ];
                keys[7] = [ 001, 002, 003, 004, 005, 006, 196, 127, 014, 207 ];
                keys[8] = [ 024, 025, 024, 025, 016, 017, 023, 023, 020, 021 ];
                keys[9] = [ 174, 175, 061, 243, 169, 170, 253, 246, 171, 172 ];
                keys[10] = [ 149, 241, 020, 021, 235, 157, 227, 167, 251, 252 ];
                keys[11] = [ 162, 225, 147, 228, 230, 232, 235, 236, 237, 237 ];
                keys[12] = [ 128, 135, 165, 164, 152, 159, 044, 249, 173, 168 ];
                keys[13] = [ 131, 132, 133, 160, 248, 134, 142, 143, 145, 146 ];
                
   
                keys[14] = [ 136, 137, 138, 130, 144, 140, 139, 141, 161, 158 ];
                keys[15] = [ 147, 148, 149, 224, 167, 150, 129, 151, 163, 154 ];
               
                console.log("keyCode:"+keyCode);
                if ( (keyCode>=48) && (keyCode<=57) )
                {
                        if (keyCode==48) keyCode=9; else
                        keyCode=keyCode-49;
                   
                        executeKey(keys[(currentCharset-1)][keyCode]);
                   
                    return true;
                }
                
                switch(keyCode){
                    case 249 :
                               executeKey(151); // high two becomes ( for french keyboard
                        return true;
                        break;
                            
                    case 178: executeKey(40); // high two becomes ( for french keyboard
                        return true;
                        break;
                            
                       case 224: executeKey(133); // a accent
                             
                
                      return true;
                        case 232: executeKey(138); // e accent
                             
                
                      return true;
                      break;
                         case 231: executeKey(135); // ca
                             
                
                      return true;
                      break;
            case 233: executeKey(130); // e accent
                
                      return true;
                      break;
            case 176 : 
                            executeKey(167);
                    return true;
                    break;
                     case 96 : // opening single quote - convert to standard single quote due to cursor right bug on single quote
                            executeKey(39);
                            return true;
                            break;
                    case 219 : // bracket right
                            executeKey(93);
                            return true;
                            break;
                        case 221: // bracket left
                            executeKey(91);
                            return true;
                            break;
                     case 220 : // UE or backslash
                            if (e.shiftKey) { 
                                executeKey(154);
                            } else {
                                executeKey(92);
                            }
                            return true;
                            break;
                             case 214 :
                            executeKey(153);
                            return true;
                            break;
                             case 196 :
                            executeKey(142);
                            return true;
                            break;
                    case 228 :
                            executeKey(132);
                            return true;
                            break;
                    case 246 :
                            executeKey(148);
                            return true;
                            break;
                        case 252 :
                            executeKey(129);
                            return true;
                            break;
                        case 191: 
                            executeKey(47);
                            return true;
                            break;
                    case 222: // single/double quote
                            if (!e.shiftKey) { 
                            executeKey(39);
                            } else {
                            executeKey(34); // double quote
                            }
                            return true;
                            break;
                    case 192 :
                            executeKey(39);
                            return true;
                            break;
                    case 48 : 
                            if (!e.shiftKey) { 
                                executeKey(48);
                            } else {
                                executeKey(61);
                            }
                            return true;
                            break;
                        case 223: // sz
                            executeKey(225);
                            break;
                    case 13 : 
                            showCharacter();
                            cursorPosX=1;
                            if (cursorPosY<getDisplayHeight()) {
                              cursorPosY++;
                            }
                            redrawCursor();
                            break;
                        case 180 : // single quote above sz
                            executeKey(39);
                            return true;
                            break;
                    case 39 : // right
                            if (e.shiftKey) { 
                              
                                        executeKey(39);
                              }
                              return true;
                              break;
                          case 40 : // down
                              if (e.shiftKey) { 
                              
                              executeKey(40);
                              }
                              return true;
                              break;
                          case 37: // left, %
                              if (e.shiftKey) { 
                                
                                  executeKey(37);
                              }
                            return true;
                              break;
                          case 38: // up
                               if (e.shiftKey) { 
                              
                                   executeKey(38);
                               }
                            return true;
                              break;
                          case 8:
                              cursorPosX--;
                              var currentPos = cursorPosX;
                              
                              while (currentPos < getDisplayWidth()) 
                              {
                                      var asciiCode = screenCharacterArray[cursorPosY][currentPos+1][0];
                                      var fgcolor = screenCharacterArray[cursorPosY][currentPos+1][1];
                                      var bgcolor = screenCharacterArray[cursorPosY][currentPos+1][2];
                                      codepage.drawChar(ctx, asciiCode, fgcolor, bgcolor, currentPos, cursorPosY);
                                      currentPos++;                                      
                              }
                              
                              redrawCursor();
                          return true;
                         
                          default : 
                              
                                  
                                 
                                executeKey(keyCode);
                           
                              return true;
                              break;
                }
                return false;
   }
   
   
   
   function handleKeyCode2(keyCode,e) {
             
                
                switch(keyCode){
             
                    case 39 : // right
                            if (!e.shiftKey) { 
                                showCharacter();
                                if (cursorPosX<getDisplayWidth()) {
                                    cursorPosX++;
                                    redrawCursor();
                                }
                              }
                              return true;
                              break;
                          case 40 : // down
                              if (!e.shiftKey) {
                                showCharacter();
                                if (cursorPosY<getDisplayHeight()) {
                                cursorPosY++;
                                redrawCursor();
                                }
                              }
                              return true;
                              break;
                          case 37: // left, %
                              if (!e.shiftKey) { 
                              showCharacter();
                              if (cursorPosX>1) {
                              cursorPosX--;
                              redrawCursor();
                            }
                              }
                            return true;
                              break;
                          case 38: // up
                               if (!e.shiftKey) { 
                              showCharacter();
                              if (cursorPosY>1) {
                                    cursorPosY--;
                                    redrawCursor();
                                }
                               }
                              
                              break;
                          default:
                         
                              return true;
                              break;
                }
                return false;
   }
   
   function executeKey(keyCode) {
       
       if (insert==false) {
                                    codepage.drawChar(ctx, keyCode, currentForeground, currentBackground, cursorPosX, cursorPosY);
                                    if (cursorPosX<getDisplayWidth()) { cursorPosX++; }
                                    redrawCursor();
                                } else {
                                    var currentPos=getDisplayWidth();
                                    while (currentPos>cursorPosX) 
                                    {
                                      var asciiCode = screenCharacterArray[cursorPosY][currentPos-1][0];
                                      var fgcolor = screenCharacterArray[cursorPosY][currentPos-1][1];
                                      var bgcolor = screenCharacterArray[cursorPosY][currentPos-1][2];

                                      codepage.drawChar(ctx, asciiCode, fgcolor, bgcolor, currentPos, cursorPosY);
                                      currentPos--;
                                      
                                    }
                                    codepage.drawChar(ctx, keyCode, currentForeground, currentBackground, cursorPosX, cursorPosY);
                                    if (cursorPosX<getDisplayWidth()) { cursorPosX++; }
                                    redrawCursor();
                                }
       
   }
   
    function clearScreen() 
    {
       cursorPosX = 1;
       cursorPosY=1;
       redrawCursor();
      
       while (cursorPosY<=height) 
       {
        cursorPosX=1;
        while (cursorPosX<=width) 
        {
               
                codepage.drawChar(ctx, 32, currentForeground, currentBackground, cursorPosX, cursorPosY, false);
                cursorPosX++;
        }
        cursorPosY++;
       }
       cursorPosX=1;
       cursorPosY=1;
       redrawCursor();
    }
   
   function registerKeyEventListener() { 
		
                document.body.addEventListener('keypress',
                function(e)
                {
                    
                    var keyCode = e.which;
                    if (keyCode!=0) {
                        if(window.handleKeyCode(keyCode,e)) e.preventDefault();
                    }
                
                },
                false);
                
                document.body.addEventListener('keydown',
                function(e)
                {
                    var keyCode = e.which;
                    if ( (keyCode<=40) && (keyCode>=37) ) { 
                        if(window.handleKeyCode2(keyCode,e)) e.preventDefault();
                    }
                    
                
                },
                false);
                
               
                
    }
    
    $(document).ready(function(){
           
            $('#foreground_color').simpleColor({
              boxHeight: 40,
              cellWidth: 40,
              cellHeight: 20,
              chooserCSS: { 'border': '1px solid #660033' },
              displayCSS: { 'border': '1px solid red' },
              displayColorCode: true,
              colors : ansicolors,
              livePreview: true,
              // element is a html element
              onSelect: function(hex, element) {
             
                for (var i = 0; i < ansicolors.length; i++) {
                    if (ansicolors[i]==hex) {
                        currentForeground=i;
                    }
                }
              },
              onCellEnter: function(hex, element) {
              },
              onClose: function(element) {
              }
            });
            $('#background_color').simpleColor({
              boxHeight: 40,
              cellWidth: 40,
              cellHeight: 20,
              chooserCSS: { 'border': '1px solid #660033' },
              displayCSS: { 'border': '1px solid red' },
              displayColorCode: true,
              colors : ansicolors,
              livePreview: true,
              // element is a html element
              onSelect: function(hex, element) {
             
                for (var i = 0; i < ansicolors.length; i++) {
                    if (ansicolors[i]==hex) {
                        currentBackground=i;
                    }
                }
              },
              onCellEnter: function(hex, element) {
              },
              onClose: function(element) {
              }
            });
           
    });
    
        
        function resize_canvas(){
            
            canvas = document.getElementById("ansi");
            ctx = document.getElementById("ansi").getContext("2d");
            resize(canvas);
           
            for (var y = 1; y < screenCharacterArray.length; y++) {
           
                for (var x = 1; x < screenCharacterArray[y].length; x++) {
                
                    
                     
                     var charArray = screenCharacterArray[y][x];
                     asciiCode=charArray[0];
                     foreground=charArray[1];
                     background=charArray[2];
                    
                    
                     codepage.drawChar(ctx, asciiCode, foreground, background, x, y, false);
                     
                }
            }
        }
        
        function resize(canvas) {
      
        var window_innerWidth = $(window).width();
        var window_innerHeight = $(window).height();
      
                var canvaswidth  = window_innerWidth-20;
                var canvasheight=Math.floor(window_innerWidth*0.5625);
                if (canvasheight>(window_innerHeight-20)) {
                    x=(window_innerHeight-20)/canvasheight;
                    canvasheight=Math.floor(canvasheight*x);
                    canvaswidth=Math.floor(canvaswidth*x);
                }
                
                canvas.width=canvaswidth;
                canvas.height=canvasheight;
              
                
                canvasCharacterWidth=Math.floor(canvaswidth/getDisplayWidth());
                canvasCharacterHeight=Math.floor(canvasheight/getDisplayHeight());
              
                
            return canvas;
        }
        
    </script>
</head>
<body onload="registerKeyEventListener();initansicanvas();"> <!-- initboxcanvas(); -->
    <!--
    Image width: <input autocomplete="off" type="text" id="imagewidth" value="800">
    Image height: <input autocomplete="off" type="text" id="imageheight" value="500">
    Display width: <input autocomplete="off" type="text" id="displaywidth" value="80">
    Display height: <input autocomplete="off" type="text" id="displayheight" value="50">
    <br />
	<canvas id="boxcanvas" width="800" height="500" style="border: 1px solid black;">
        Your browser does not support canvas
        </canvas>
    --><div style="width: 640px" class="centered">
        <canvas id="ansi" width=640 height=480></canvas>
        <script type="text/javascript">
             setANSICanvasSize();
         
            codepage = new Codepage("images/CO_437_8x16.png", function() {
            
            var interpreter, display, ctx, charactersatonce;

            function drawChunk() {
                if (interpreter.read(charactersatonce, display)) {
             
                ctx.drawImage(display.canvas, 0, 0);
                } else {
                 
                    interpreter.reset();
                    display.clearScreen();
                    //setTimeout(drawChunk, 5000);
                }
            }

            ctx = document.getElementById("ansi").getContext("2d");
            display = new Display();
            charactersatonce = 999999; //Math.floor((baud || 115200) / 8 / 100);
            
            interpreter = new Interpreter("rad-PIRANHA.ANS", drawChunk);
            resize_canvas();
        });
        
      
        
       function myexport() {
       
                cursorPosX = 1;
                cursorPosY=1;

                var html="";

                while (cursorPosY<=height) 
                {
                 cursorPosX=1;
                 while (cursorPosX<=width) 
                 {
                        var charArray = screenCharacterArray[cursorPosY][cursorPosX];

                        var asciiCode = charArray[0].toString();
                        var foreground = charArray[1].toString();
                        var background = charArray[2].toString();
                        
                        while (asciiCode.length<3) asciiCode="0"+asciiCode;
                        while (foreground.length<3) foreground="0"+foreground;
                        while (background.length<3) background="0"+background;
                        html+=asciiCode+foreground+background;

                        cursorPosX++;
                 }
                 html+="newline";
                 cursorPosY++;
                }
                cursorPosX=1;
                cursorPosY=1;

                $.ajax({
                url: 'export.php',
                type: 'POST',
                data: { value: html },
                success: function(result) {
                    alert('the request was successfully sent to the server');
                }
                });
            
        }
        </script>
    </div>
  <h3>Foreground color</h3>
  <input id='foreground_color' value='#993300'/>
  <h3>Background color</h3>
  <input id='background_color' value='#993300'/>
  <br /><br />
  <span onclick="insert=!insert;">toggle cursor</span><br />
  <span onclick="drawingMode=!drawingMode;">toggle drawing mode</span><br />
  <span onclick="clearScreen();">clear screen</span><br />
  <span onclick="$('#popup').bPopup();">change width and height</span><br />
  <span onclick="myexport();">export to xterm ansi</span>
  
  
  
  <img src="images/ansimap.png" border="0" usemap="#ansimap">
  <map id="ansimap" name="ansimap">
      <area shape="rect" alt="a1" title="" coords="0,0,22,12" onclick="setD(49,1);"/>
      <area shape="rect" alt="a2" title="" coords="22,0,48,12" onclick="setD(50,1);"  />
      <area shape="rect" alt="a3" title="" coords="48,0,72,12" onclick="setD(51,1);"/>
      <area shape="rect" alt="a4" title="" coords="72,0,96,12" onclick="setD(52,1);"/>
      <area shape="rect" alt="a5" title="" coords="96,0,120,12" onclick="setD(53,1);"/>
      <area shape="rect" alt="a6" title="" coords="120,0,144,12" onclick="setD(54,1);"/>
      <area shape="rect" alt="a7" title="" coords="144,0,168,12" onclick="setD(55,1);" />
      <area shape="rect" alt="a8" title="" coords="168,0,190,10" onclick="setD(56,1);"  />
      <area shape="rect" alt="a9" title="" coords="192,0,216,10" onclick="setD(57,1);" />
      <area shape="rect" alt="a0" title="" coords="214,0,238,10" onclick="setD(48,1);" />
      <area shape="rect" alt="b1" title="" coords="0,14,22,24" onclick="setD(218,2);" />
      <area shape="rect" alt="b2" title="" coords="24,12,48,22" onclick="setD(191,2);" />
      <area shape="rect" alt="b3" title="" coords="48,12,72,22" onclick="setD(192,2);" />
      <area shape="rect" alt="b4" title="" coords="72,12,96,22" onclick="setD(217,2);" />
      <area shape="rect" alt="b5" title="" coords="96,12,120,22" onclick="setD(196,2);" />
      <area shape="rect" alt="b6" title="" coords="122,12,144,22" onclick="setD(179,2);" />
      <area shape="rect" alt="b7" title="" coords="142,12,166,24" onclick="setD(195,2);" />
      <area shape="rect" alt="b8" title="" coords="166,12,190,24" onclick="setD(180,2);" />
      <area shape="rect" alt="b9" title="" coords="192,12,216,22" onclick="setD(193,2);" />
      <area shape="rect" alt="b0" title="" coords="216,10,240,22" onclick="setD(194,2);" />
      <area shape="rect" alt="c1" title="" coords="0,24,22,32" onclick="setD(201,3);"/>
      <area shape="rect" alt="c2" title="" coords="24,24,48,34" onclick="setD(187,3);" />
      <area shape="rect" alt="c3" title="" coords="50,24,72,34" onclick="setD(200,3);" />
      <area shape="rect" alt="c4" title="" coords="74,24,96,32" onclick="setD(188,3);" />
      <area shape="rect" alt="c5" title="" coords="96,24,122,34" onclick="setD(205,3);" />
      <area shape="rect" alt="c6" title="" coords="120,24,142,32" onclick="setD(186,3);" />
      <area shape="rect" alt="c7" title="" coords="142,24,168,34" onclick="setD(204,3);" />
      <area shape="rect" alt="c8" title="" coords="168,24,192,34" onclick="setD(185,3);" />
      <area shape="rect" alt="c9" title="" coords="190,24,214,34" onclick="setD(202,3);" />
      <area shape="rect" alt="c0" title="" coords="216,24,238,34" onclick="setD(203,3);" />
      <area shape="rect" alt="d1" title="" coords="0,34,22,46" onclick="setD(251,4);" />
      <area shape="rect" alt="d2" title="" coords="24,36,48,48" onclick="setD(184,4;" />
      <area shape="rect" alt="d3" title="" coords="46,36,72,48" onclick="setD(212,4);" />
      <area shape="rect" alt="d4" title="" coords="70,34,96,48" onclick="setD(190,4);" />
      <area shape="rect" alt="d5" title="" coords="94,36,120,48" onclick="setD(205,4);" />
      <area shape="rect" alt="d6" title="" coords="118,36,144,48" onclick="setD(179,4);" />
      <area shape="rect" alt="d7" title="" coords="144,36,168,46" onclick="setD(198,4);" />
      <area shape="rect" alt="d8" title="" coords="166,36,192,46" onclick="setD(181,4);" />
      <area shape="rect" alt="d9" title="" coords="190,36,214,46" onclick="setD(207,4);" />
      <area shape="rect" alt="d0" title="" coords="214,34,238,44" onclick="setD(209,4);" />
      <area shape="rect" alt="e1" title="" coords="0,48,24,60" onclick="setD(161,5);" />
      <area shape="rect" alt="e2" title="" coords="24,48,48,60" onclick="setD(183,5);" />
      <area shape="rect" alt="e3" title="" coords="48,50,74,60" onclick="setD(211,5);" />
      <area shape="rect" alt="e4" title="" coords="72,50,98,58" onclick="setD(135,5);" />
      <area shape="rect" alt="e5" title="" coords="96,48,118,56" onclick="setD(179,5);" />
      <area shape="rect" alt="e6" title="" coords="118,48,144,58" onclick="setD(186,5);" />
      <area shape="rect" alt="e7" title="" coords="142,48,166,56" onclick="setD(199,5);" />
      <area shape="rect" alt="e8" title="" coords="166,48,192,56" onclick="setD(182,5);" />
      <area shape="rect" alt="e9" title="" coords="188,48,214,58" onclick="setD(208,5);" />
      <area shape="rect" alt="e0" title="" coords="218,48,236,58" onclick="setD(144,5);" />
      <area shape="rect" alt="f1" title="" coords="0,60,22,72" onclick="setD(197,6);" />
      <area shape="rect" alt="f2" title="" coords="24,60,48,70" onclick="setD(206,6);" />
      <area shape="rect" alt="f3" title="" coords="48,60,72,70" onclick="setD(139,6);" />
      <area shape="rect" alt="f4" title="" coords="72,60,96,70" onclick="setD(140,6);" />
      <area shape="rect" alt="f5" title="" coords="96,60,118,70" onclick="setD(232,6);" />
      <area shape="rect" alt="f6" title="" coords="118,60,144,70" onclick="setD(163,6);" />
      <area shape="rect" alt="f7" title="" coords="140,60,168,70" onclick="setD(155,6);" />
      <area shape="rect" alt="f8" title="" coords="166,60,192,68" onclick="setD(156,6);" />
      <area shape="rect" alt="f9" title="" coords="194,60,216,68" onclick="setD(153,6);" />
      <area shape="rect" alt="f0" title="" coords="218,60,240,70" onclick="setD(239,6);" />
      <area shape="rect" alt="g1" title="" coords="0,74,24,84" onclick="setD(176,7);" />
      <area shape="rect" alt="g2" title="" coords="24,74,46,84" onclick="setD(177,7);" />
      <area shape="rect" alt="g3" title="" coords="48,72,74,82" onclick="setD(178,7);" />
      <area shape="rect" alt="g4" title="" coords="72,72,96,82" onclick="setD(219,7);" />
      <area shape="rect" alt="g5" title="" coords="96,72,120,80" onclick="setD(223,7);" />
      <area shape="rect" alt="g6" title="" coords="120,72,142,80" onclick="setD(219,7);" />
      <area shape="rect" alt="g7" title="" coords="142,72,168,82" onclick="setD(124,7);" />
      <area shape="rect" alt="g8" title="" coords="168,72,192,80" onclick="setD(141,7);" />
      <area shape="rect" alt="g9" title="" coords="192,72,216,82" onclick="setD(254,7);" />
      <area shape="rect" alt="g0" title="" coords="218,72,238,82" onclick="setD(250,7);" />
      <area shape="rect" alt="h1" title="" coords="0,84,22,94" onclick="setD(001,8;" />
      <area shape="rect" alt="h2" title="" coords="24,84,48,94" onclick="setD(002,8);" />
      <area shape="rect" alt="h3" title="" coords="50,84,74,92" onclick="setD(003,8);" />
      <area shape="rect" alt="h4" title="" coords="70,84,96,94" onclick="setD(004,8);" />
      <area shape="rect" alt="h5" title="" coords="94,84,118,94" onclick="setD(005,8);" />
      <area shape="rect" alt="h6" title="" coords="118,84,142,94" onclick="setD(006,8);" />
      <area shape="rect" alt="h7" title="" coords="142,84,168,94" onclick="setD(196,8);" />
      <area shape="rect" alt="h8" title="" coords="168,84,194,94" onclick="setD(127,8);" />
      <area shape="rect" alt="h9" title="" coords="192,84,216,94" onclick="setD(14,8);" />
      <area shape="rect" alt="h0" title="" coords="216,84,240,94" onclick="setD(207,8);" />
      <area shape="rect" alt="i1" title="" coords="0,96,22,106" onclick="setD(24,9);" />
      <area shape="rect" alt="i2" title="" coords="22,96,48,108" onclick="setD(25,9);" />
      <area shape="rect" alt="i3" title="" coords="48,96,72,106" onclick="setD(24,9);" />
      <area shape="rect" alt="i4" title="" coords="74,96,96,106" onclick="setD(25,9);" />
      <area shape="rect" alt="i5" title="" coords="96,96,120,104" onclick="setD(16,9);" />
      <area shape="rect" alt="i6" title="" coords="120,96,142,106" onclick="setD(17,9);" />
      <area shape="rect" alt="i7" title="" coords="142,94,164,104" onclick="setD(23,9);" />
      <area shape="rect" alt="i8" title="" coords="166,96,190,106" onclick="setD(23,9);" />
      <area shape="rect" alt="i9" title="" coords="192,96,214,104" onclick="setD(20,9);" />
      <area shape="rect" alt="i0" title="" coords="216,96,238,106" onclick="setD(21,9);" />
      <area shape="rect" alt="j1" title="" coords="0,108,24,118" onclick="setD(174,10);" />
      <area shape="rect" alt="j2" title="" coords="24,108,48,120" onclick="setD(175,10);" />
      <area shape="rect" alt="j3" title="" coords="50,108,72,118" onclick="setD(61,10);" />
      <area shape="rect" alt="j4" title="" coords="72,108,96,118" onclick="setD(243,10);" />
      <area shape="rect" alt="j5" title="" coords="96,108,118,118" onclick="setD(169,10);" />
      <area shape="rect" alt="j6" title="" coords="118,106,144,116" onclick="setD(170,10);" />
      <area shape="rect" alt="j7" title="" coords="144,106,168,116" onclick="setD(253,10);" />
      <area shape="rect" alt="j8" title="" coords="168,106,190,116" onclick="setD(246,10);" />
      <area shape="rect" alt="j9" title="" coords="190,106,216,116" onclick="setD(171,10);" />
      <area shape="rect" alt="j0" title="" coords="218,108,238,118" onclick="setD(172,10);" />
      <area shape="rect" alt="k1" title="" coords="0,120,22,130" onclick="setD(149,11);" />
      <area shape="rect" alt="k2" title="" coords="24,118,48,130" onclick="setD(241,11);" />
      <area shape="rect" alt="k3" title="" coords="48,118,70,128" onclick="setD(20,11);" />
      <area shape="rect" alt="k4" title="" coords="70,120,96,130" onclick="setD(21,11);" />
      <area shape="rect" alt="k5" title="" coords="94,120,122,130" onclick="setD(234,11);" />
      <area shape="rect" alt="k6" title="" coords="120,118,144,128" onclick="setD(157,11);" />
      <area shape="rect" alt="k7" title="" coords="144,118,166,128" onclick="setD(228,11);" />
      <area shape="rect" alt="k8" title="" coords="166,118,190,128" onclick="setD(167,11);" />
      <area shape="rect" alt="k9" title="" coords="190,118,214,130" onclick="setD(251,11);" />
      <area shape="rect" alt="k0" title="" coords="218,120,238,128" onclick="setD(252,11);" />
      <area shape="rect" alt="l1" title="" coords="2,132,26,142" onclick="setD(162,12);" />
      <area shape="rect" alt="l2" title="" coords="26,132,48,142" onclick="setD(225,12);" />
      <area shape="rect" alt="l3" title="" coords="50,130,70,140" onclick="setD(147,12);" />
      <area shape="rect" alt="l4" title="" coords="72,130,96,140" onclick="setD(228,12);" />
      <area shape="rect" alt="l5" title="" coords="96,130,120,140" onclick="setD(230,12);" />
      <area shape="rect" alt="l6" title="" coords="120,132,144,140" onclick="setD(232,12);" />
      <area shape="rect" alt="l7" title="" coords="144,130,168,140" onclick="setD(235,12);" />
      <area shape="rect" alt="l8" title="" coords="166,132,192,140" onclick="setD(236,12);" />
      <area shape="rect" alt="l9" title="" coords="190,130,214,140" onclick="setD(237,12);" />
      <area shape="rect" alt="l0" title="" coords="216,130,238,140" onclick="setD(237,12);" />
      <area shape="rect" alt="m1" title="" coords="2,140,26,150" onclick="setD(128,13);" />
      <area shape="rect" alt="m2" title="" coords="26,140,48,150" onclick="setD(135,13);" />
      <area shape="rect" alt="m3" title="" coords="46,140,70,150" onclick="setD(165,13);" />
      <area shape="rect" alt="m4" title="" coords="72,140,94,150" onclick="setD(164,13);" />
      <area shape="rect" alt="m5" title="" coords="94,140,118,150" onclick="setD(152,13);" />
      <area shape="rect" alt="m6" title="" coords="120,140,142,150" onclick="setD(159,13);" />
      <area shape="rect" alt="m7" title="" coords="144,140,166,150" onclick="setD(44,13);" />
      <area shape="rect" alt="m8" title="" coords="166,140,188,150" onclick="setD(249,13);" />
      <area shape="rect" alt="m9" title="" coords="190,140,214,150" onclick="setD(173,13);" />
      <area shape="rect" alt="m0" title="" coords="216,140,238,150" onclick="setD(168,13);" />
      <area shape="rect" alt="n1" title="" coords="2,150,26,163" onclick="setD(131,14);" />
      <area shape="rect" alt="n2" title="" coords="26,150,48,163" onclick="setD(132,14);" />
      <area shape="rect" alt="n3" title="" coords="46,150,70,163" onclick="setD(133,14);" />
      <area shape="rect" alt="n4" title="" coords="72,150,94,163" onclick="setD(160,14);" />
      <area shape="rect" alt="n5" title="" coords="94,150,118,163" onclick="setD(248,14);" />
      <area shape="rect" alt="n6" title="" coords="120,150,142,163" onclick="setD(134,14);" />
      <area shape="rect" alt="n7" title="" coords="144,150,166,163" onclick="setD(142,14);" />
      <area shape="rect" alt="n8" title="" coords="166,150,188,163" onclick="setD(143,14);" />
      <area shape="rect" alt="n9" title="" coords="190,150,214,163" onclick="setD(145,14);" />
      <area shape="rect" alt="n0" title="" coords="216,150,238,163" onclick="setD(146,14);" />
      <area shape="rect" alt="o1" title="" coords="2,163,26,174" onclick="setD(147,15);" />
      <area shape="rect" alt="o2" title="" coords="26,163,48,174" onclick="setD(148,15);" />
      <area shape="rect" alt="o3" title="" coords="46,163,70,174" onclick="setD(149,15);" />
      <area shape="rect" alt="o4" title="" coords="72,163,94,174" onclick="setD(224,15);" />
      <area shape="rect" alt="o5" title="" coords="94,163,118,174" onclick="setD(167,15);" />
      <area shape="rect" alt="o6" title="" coords="120,163,142,174" onclick="setD(150,15);" />
      <area shape="rect" alt="o7" title="" coords="144,163,166,174" onclick="setD(129,15);" />
      <area shape="rect" alt="o8" title="" coords="166,163,188,174" onclick="setD(151,15);" />
      <area shape="rect" alt="o9" title="" coords="190,163,214,174" onclick="setD(163,15);" />
      <area shape="rect" alt="o0" title="" coords="216,163,238,174" onclick="setD(154,15);" />
      <area shape="rect" alt="o1" title="" coords="2,175,26,196" onclick="setD(226,16);" />
      <area shape="rect" alt="o2" title="" coords="26,175,48,196" onclick="setD(153,16);" />
      <area shape="rect" alt="o3" title="" coords="46,175,70,196" onclick="setD(227,16);" />
      <area shape="rect" alt="o4" title="" coords="72,175,94,196" onclick="setD(224,16);" />
      <area shape="rect" alt="o5" title="" coords="94,175,118,196" onclick="setD(167,16);" />
      <area shape="rect" alt="o6" title="" coords="120,175,142,196" onclick="setD(129,16);" />
      <area shape="rect" alt="o7" title="" coords="144,175,166,196" onclick="setD(234,16);" />
      <area shape="rect" alt="o8" title="" coords="166,175,188,196" onclick="setD(151,16);" />
      <area shape="rect" alt="o9" title="" coords="190,175,214,196" onclick="setD(163,16);" />
      <area shape="rect" alt="o0" title="" coords="216,175,238,196" onclick="setD(154,16);" />
  </map>
  <div id="popup">
        <span class="button b-close"><span>X</span></span>
        <ul>
            <li class="left">Width:</li>
            <li class="right"><input type="text" value="80" /></li>
            <li class="left">Height:</li>
            <li class="right"><input type="text" value="45" /></li>
            <li><input type="button" value="OK"></li>
        </ul>
  </div
  <textarea id="ansi"></textarea>
</body>
</html>